// Production Prisma schema with PostgreSQL support
// Used for Railway deployment

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id          Int      @id @default(autoincrement())
  telegramId  String   @unique
  username    String?
  firstName   String?
  lastName    String?
  photoUrl    String?  // Telegram profile photo URL
  password    String?  // For admin password login
  role        String   @default("USER") // "ADMIN" or "USER"
  isApproved  Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  accessibleEntities EntityAccess[]
  changeHistory      ChangeHistory[]

}

model Entity {
  id        String   @id // Using the existing string IDs (e.g., "ent_cmh1")
  name      String
  data      String   @db.Text // JSON string storing the complex nested structure (profiles, limits, etc.)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  accessList EntityAccess[]
  proxies    ProxyServer[]
}

model EntityAccess {
  id        Int    @id @default(autoincrement())
  userId    Int
  entityId  String
  
  user      User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  entity    Entity @relation(fields: [entityId], references: [id], onDelete: Cascade)

  @@unique([userId, entityId])
}

model ProxyPartition {
  id        Int      @id @default(1) // Singleton pattern, always use ID 1
  data      String   @db.Text // JSON string storing ProcessedData
  updatedAt DateTime @updatedAt
}

model ChangeHistory {
  id          Int      @id @default(autoincrement())
  entityId    String?  // Entity ID if this is an entity change
  entityType  String   // "entity", "proxy", "reporting", "limits", "notes", etc.
  changeType  String   // "create", "update", "delete"
  fieldChanged String? // Specific field that was changed (optional)
  userId      Int      // User who made the change
  username    String   // Username for quick display
  userRole    String   // Role at time of change (ADMIN, MAILER, USER)
  description String   @db.Text // Human-readable description of the change
  oldValue    String?  @db.Text // JSON string of old value (optional)
  newValue    String?  @db.Text // JSON string of new value (optional)
  methodId    String?
  categoryId  String?
  categoryName String?
  profileId   String?
  profileName String?
  batchId     String?
  createdAt   DateTime @default(now())
  
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([entityId, createdAt])
  @@index([entityType, createdAt])
}

model ProxyServer {
  id          String   @id @default(uuid())
  entityId    String
  serverName  String
  ips         String   @db.Text // JSON string storing string[]
  status      String   @default("active") // "active" or "stopped"
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  entity      Entity   @relation(fields: [entityId], references: [id], onDelete: Cascade)

  @@index([entityId])
}

// Team Planning Management System Models
model Team {
  id          String   @id @default(uuid())
  name        String   @unique // e.g., "DESKTOP", "Webautomat", "HOTMAIL", "Gmail"
  displayName String   // Display name for UI
  order       Int      @default(0) // For sorting teams in UI
  color       String?  // Optional color code for UI
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  mailers     Mailer[]
  
  @@index([order])
}

model Mailer {
  id          String   @id @default(uuid())
  name        String   // e.g., "Khadija Hafid", "Hicham El Ouafir"
  teamId      String
  order       Int      @default(0) // For sorting within team
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  team        Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  assignments PlanningAssignment[]

  
  @@index([teamId, order])
}

model PlanningSchedule {
  id          String   @id @default(uuid())
  weekStart   DateTime // Monday of the week
  weekEnd     DateTime // Sunday of the week
  weekNumber  Int      // Week number in year
  year        Int      // Year
  isCurrent   Boolean  @default(false) // Is this the current week?
  isNext      Boolean  @default(false) // Is this the next week?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  assignments PlanningAssignment[]
  
  @@unique([year, weekNumber])
  @@index([weekStart])
  @@index([isCurrent, isNext])
}

model PlanningAssignment {
  id          String   @id @default(uuid())
  scheduleId  String
  mailerId    String
  dayOfWeek   Int      // 0=Monday, 1=Tuesday, ..., 6=Sunday
  taskCode    String   // e.g., "CMH3", "CMH12-CMH5-16", "cong√©", "HOTMAIL"
  taskColor   String?  // Color code for the task (green, yellow, orange, etc.)
  notes       String?  @db.Text // Optional notes
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   Int?     // User who created this assignment
  updatedBy   Int?     // User who last updated this assignment
  
  schedule    PlanningSchedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)
  mailer      Mailer   @relation(fields: [mailerId], references: [id], onDelete: Cascade)
  
  @@unique([scheduleId, mailerId, dayOfWeek])
  @@index([scheduleId, dayOfWeek])
  @@index([mailerId])
}

// Quick Assign Presets for Team Planning
model PlanningPreset {
  id          String   @id @default(uuid())
  label       String   @unique // e.g., "CMH3-CMH9"
  codes       String   // JSON array of codes, e.g., '["CMH3", "CMH9"]'
  color       String   // Color code for the preset, e.g., "#90EE90"
  order       Int      @default(0) // For sorting presets in UI
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([order])
}



// Day Plan - Stores customized STEP and START values per session per category per date
model DayPlan {
  id              String   @id @default(uuid())
  entityId        String
  categoryId      String   // Category ID from entity.reporting.parentCategories
  date            DateTime // The date this plan is for
  sessionData     String   @db.Text // JSON: { [sessionIndex: number]: { step: number, start: number } }
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  createdBy       Int?     // User who created
  updatedBy       Int?     // User who last updated
  
  @@unique([entityId, categoryId, date])
  @@index([entityId, date])
  @@index([categoryId])
}

// =====================
// Script & Scenario Models
// =====================

// Script - A script that can have multiple scenarios
model Script {
  id          String   @id @default(uuid())
  name        String   @unique // e.g., "CMH1_Warmup_Script_v2"
  description String?  @db.Text // Optional description
  order       Int      @default(0) // For sorting in dropdown
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  scenarios   Scenario[]
  
  @@index([order])
  @@index([isActive])
}

// Scenario - Belongs to a Script
model Scenario {
  id          String   @id @default(uuid())
  name        String   // e.g., "Standard_Rotation_A"
  scriptId    String   // Foreign key to Script
  description String?  @db.Text // Optional description
  order       Int      @default(0) // For sorting in dropdown
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  script      Script   @relation(fields: [scriptId], references: [id], onDelete: Cascade)
  
  @@unique([scriptId, name]) // Unique scenario name per script
  @@index([scriptId])
  @@index([order])
  @@index([isActive])
}

// Reporting Method - Dynamic methods for entities
model ReportingMethod {
  id          String   @id // e.g., "desktop", "webautomate"
  name        String
  description String?  @db.Text
  icon        String   // Lucide icon name
  color       String
  gradient    String
  order       Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model IntervalPauseHistory {
  id           Int      @id @default(autoincrement())
  entityId     String
  methodId     String
  categoryId   String
  categoryName String?
  profileName  String
  pauseType    String
  interval     String
  action       String
  userId       Int
  username     String
  createdAt    DateTime @default(now())

  @@index([entityId, createdAt])
  @@index([methodId, categoryId])
}

